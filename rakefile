require 'zip/zip'

#############################################
# Configuration
#############################################

#find flex sdk
[
	ENV['FLEX_HOME'],
	'C:\develop\sdk\flex_sdk_4.6.0.23201',
	'C:\develop\sdk\flex_sdk_4.5.1.21328'
].each do |path|
	if path != nil && File.exists?(path)
		FLEX_HOME = path
		MXMLC = File.join(FLEX_HOME, 'bin', 'mxmlc')
		COMPC = File.join(FLEX_HOME, 'bin', 'compc')
		ASDOC = File.join(FLEX_HOME, 'bin', 'asdoc')
		break
	end
end

if FLEX_HOME != nil
	puts "Using Flex SDK at #{FLEX_HOME}"
else
	puts "\nrake aborted!"
	puts "Could not find Flex SDK"
	exit
end

#############################################
# Build the project
#############################################

task :default => [:build]

#namespace :library do

	directory PROJECT[:output_dir]

	desc 'Compile the swc'
	task :build => [PROJECT[:output_dir]] do
		puts "\n:build"
		#puts get_all_classes('src')

		run "#{COMPC} -load-config+=compc_config.xml -output #{File.join(PROJECT[:output_dir], PROJECT[:output_file])}"

		puts ":build complete\n"
	end

	desc 'Package the project into a zip'
	task :package => [:clean, :build] do
		puts "\n:package"
		cp "../../LICENSE", "#{PROJECT[:output_dir]}/license.txt"

		Zip::ZipFile.open(File.join(PROJECT[:output_dir], PROJECT[:package_file]), Zip::ZipFile::CREATE) do |z|
			z.add("license.txt", "#{PROJECT[:output_dir]}/license.txt")
			z.add(PROJECT[:output_file], File.join(PROJECT[:output_dir], PROJECT[:output_file]))
		end

		puts ":package complete\n"
	end

	desc 'Remove the results of a build/package'
	task :clean do
		puts "\n:clean"

		rm_r PROJECT[:output_dir] rescue nil

		puts ":clean complete\n"
	end

	desc 'Run the unit tests against src'
	task :test do
		puts "\n:test"

		puts "NOT YET IMPLEMENTED"

		puts ":test complete\n"
	end
	
#end

#############################################
# Utility methods
#############################################

def get_all_classes(path)
	Dir.chdir(path) do
		FileList["**/*.as"].pathmap('%d/%n').map do |f|
			f.gsub(/^\.\//, '').gsub('/', '.')
		end
	end
end

def run(command)
	puts "\n> Running shell command"
	
	if is_windows?
		sh command.gsub('/', '\\')
	else
		sh command
	end

	puts "<\n\n"
end

def is_windows?
	require 'rbconfig'
	RbConfig::CONFIG['host_os'] =~ /mswin|mingw/
end